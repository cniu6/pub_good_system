# 数据模型与数据库交互逻辑 (Models) 深度流证

## 简介
定义系统核心数据实体及数据库持久化操作。本系统严格遵守数据库命名规范，确保前后端数据一致性。

## 数据库命名规范 (Database Naming Convention)
- **禁用峰驼命名**: 数据库名称、表名、字段名严禁使用 CamelCase。
- **全小写+下划线**: 所有数据库相关的标识符（表名、字段名、索引名）必须统一使用 `小写字母` 和 `下划线` (snake_case)。
- **变量规范**: 内部变量建议优先使用 `小写_下划线` 风格，以保持与数据库层风格一致。

## 核心数据库表与字段详细流证

### 1. 用户表 (users)
存储系统用户信息，包含余额、积分、等级等扩展属性。
- **id** (`bigint_unsigned`): 主键 ID，自增。
- **group_id** (`bigint_unsigned`): 分组 ID，默认 1。
- **username** (`varchar_100`): 用户名。唯一约束，全小写存储。
- **nickname** (`varchar_100`): 昵称。
- **email** (`varchar_150`): 电子邮箱。唯一约束。
- **mobile** (`varchar_50`): 手机号。
- **avatar** (`varchar_255`): 头像 URL。
- **back_ground** (`varchar_255`): 个人主页背景图。
- **gender** (`tinyint_unsigned`): 性别: 0=未知, 1=男, 2=女。
- **birthday** (`bigint`): 生日时间戳。
- **money** (`decimal_10_2`): 账户余额。
- **score** (`bigint`): 积分。
- **level** (`bigint_unsigned`): 用户等级。
- **role** (`varchar_20`): 角色: `user` (普通用户), `admin` (管理员)。
- **last_login_time** (`bigint_unsigned`): 上次登录时间戳。
- **last_login_ip** (`varchar_50`): 上次登录 IP。
- **login_failure** (`tinyint_unsigned`): 登录失败次数。
- **join_ip** (`varchar_50`): 加入 IP。
- **join_time** (`bigint_unsigned`): 加入时间戳。
- **motto** (`varchar_255`): 个人签名。
- **password** (`varchar_255`): 密码哈希值（bcrypt）。
- **status** (`tinyint_unsigned`): 状态: 1=启用, 0=禁用。
- **apikey** (`varchar_255`): API 密钥。
- **language** (`varchar_20`): 偏好语言 (如 `zh-CN`)。
- **country** (`varchar_50`): 国家。
- **token** (`varchar_255`): 当前有效 Token。
- **update_time** (`bigint_unsigned`): 最后更新时间戳。
- **create_time** (`bigint_unsigned`): 创建时间戳。
- **delete_time** (`bigint_unsigned`): 逻辑删除时间戳。

### 2. 邮件日志表 (email_logs)
记录系统发送的所有邮件记录。
- **id** (`bigint_unsigned`): 主键。
- **to_email** (`varchar_150`): 收件人邮箱。
- **subject** (`varchar_255`): 邮件主题。
- **content** (`text`): 邮件内容。
- **template_name** (`varchar_50`): 使用的模板名称。
- **status** (`tinyint`): 发送状态: 1=成功, 0=失败。
- **error_msg** (`text`): 错误信息。
- **created_at** (`timestamp`): 创建时间。

### 3. 邮件模板表 (email_templates)
存储多语言邮件模板。
- **id** (`bigint_unsigned`): 主键。
- **name** (`varchar_100`): 模板唯一标识名。
- **lang** (`varchar_20`): 语言代码 (如 `zh-CN`)。
- **title** (`varchar_255`): 模板标题。
- **subject** (`varchar_255`): 默认邮件主题。
- **content** (`text`): 模板内容（支持变量替换）。
- **description** (`varchar_255`): 模板描述。
- **variables** (`text`): 支持的变量列表（JSON 格式）。
- **status** (`tinyint`): 状态: 1=启用, 0=禁用。

### 4. 验证码表 (verification_codes)
存储注册、重置密码等业务的验证码。
- **id** (`bigint_unsigned`): 主键。
- **email** (`varchar_150`): 关联邮箱。
- **code** (`varchar_100`): 验证码。
- **type** (`varchar_50`): 类型: `register`, `reset_password`。
- **status** (`tinyint`): 状态: 0=未使用, 1=已使用。
- **expire_at** (`timestamp`): 过期时间。
- **created_at** (`timestamp`): 创建时间。

## 数据库交互函数 (Database Functions)
- `CreateUser(user)`: 插入新用户，处理时间戳。
- `GetUserByUsername(username)`: 按用户名查询（排除已删除）。
- `GetUserByEmail(email)`: 按邮箱查询（排除已删除）。
- `GetEmailTemplate(name, lang)`: 获取指定语言的模板，若不存在则回退至 `zh-CN`。

## SQL 实现流证 (以 Users 表为例)
```sql
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(100) NOT NULL UNIQUE,
    email VARCHAR(150) NOT NULL UNIQUE,
    status TINYINT UNSIGNED NOT NULL DEFAULT 1,
    create_time BIGINT UNSIGNED NULL,
    update_time BIGINT UNSIGNED NULL,
    delete_time BIGINT UNSIGNED NULL
    -- 其他字段详见 internal/db/mysql.go
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 注意事项
- 所有的 `db` 标签在 Go 结构体中必须与数据库字段名完全匹配（小写+下划线）。
- 查询语句中严禁使用 `SELECT *`，应明确列出所需字段（本系统底层实现已优化，但规范仍需遵守）。
