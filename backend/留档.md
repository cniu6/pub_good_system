# Backend 目录留档

> 📁 **文件位置**: `backend/留档.md`
> 
> **最后更新**: 2026-02-04

---

## 📂 目录结构

```
backend/
├── app/                    # 业务逻辑核心
│   ├── controllers/        # HTTP 请求处理器
│   │   ├── auth_controller.go      # 认证相关
│   │   └── system_controller.go    # 系统相关
│   ├── models/             # 数据模型与数据库操作
│   │   ├── user.go                 # 用户模型
│   │   ├── email.go                # 邮件模型
│   │   ├── verification_code.go    # 验证码模型
│   │   └── base.go                 # 基础模型
│   └── plugins/            # 插件系统
│       ├── interface.go            # 插件接口定义
│       └── demo/                   # 示例插件
├── cmd/                    # 程序启动入口
│   └── main.go                     # 主程序入口
├── internal/               # 内部库（不暴露给外部）
│   ├── config/             # 配置管理
│   │   └── config.go               # 配置加载
│   ├── db/                 # 数据库连接
│   │   └── mysql.go                # MySQL连接
│   └── middleware/         # HTTP中间件
│       ├── auth.go                 # 认证中间件
│       └── cors.go                 # 跨域中间件
├── routes/                 # 路由定义
│   └── routes.go                   # 路由设置
├── utils/                  # 通用工具函数
│   ├── email.go                    # 邮件发送
│   ├── jwt.go                      # JWT工具
│   ├── password.go                 # 密码处理
│   ├── response.go                 # 响应封装
│   └── geetest.go                  # 极验验证
└── docs/                   # Swagger 文档
    ├── docs.go
    ├── swagger.json
    └── swagger.yaml
```

---

## 🚀 快速开始

### 运行后端

```bash
# 从项目根目录
go run backend/cmd/main.go

# 或使用开发脚本
./dev.bat  # Windows
./dev.ps1  # Windows PowerShell
```

### 数据库迁移

```bash
# 自动迁移（启动时自动执行）
# 或手动执行 SQL
cat backend/internal/db/mysql.go | grep "CREATE TABLE"
```

---

## 📚 核心模块

### 1. 认证系统

**关键文件**:
- `app/controllers/auth_controller.go` - 登录、注册、Token刷新
- `utils/jwt.go` - Token生成与验证
- `middleware/auth.go` - 认证中间件

**使用方式**:
```go
// 生成Token
token, err := utils.GenerateToken(userID, role)

// 验证Token
claims, err := utils.ParseToken(tokenString)

// 保护路由
protected.Use(middleware.AuthMiddleware())
```

📖 **详细文档**: [../doc/JWT认证.md](../doc/JWT认证.md)

### 2. 邮件系统

**关键文件**:
- `utils/email.go` - 邮件发送核心
- `app/models/email.go` - 邮件模板和日志
- `app/controllers/auth_controller.go` - 发送验证码/重置邮件

**使用方式**:
```go
// 发送邮件
err := utils.SendEmail(utils.EmailMessage{
    To:      "user@example.com",
    Subject: "验证码",
    Body:    "您的验证码是：123456",
})

// 使用模板
tpl, _ := models.GetEmailTemplate("register_code", "zh-CN")
```

📖 **详细文档**: [../doc/邮件系统.md](../doc/邮件系统.md)

### 3. 数据库操作

**关键文件**:
- `internal/db/mysql.go` - 数据库连接
- `app/models/*.go` - 数据模型

**使用方式**:
```go
// 查询
user, err := models.GetUserByID(id)

// 创建
err := models.CreateUser(user)

// 更新
err := models.UpdateUser(user)
```

📖 **详细文档**: [../doc/数据库模型.md](../doc/数据库模型.md)

### 4. 插件系统

**关键文件**:
- `app/plugins/interface.go` - 插件接口
- `app/plugins/demo/plugin.go` - 示例插件

**使用方式**:
```go
// 创建插件
func (p *MyPlugin) RegisterRoutes(router *gin.RouterGroup) {
    router.GET("/api/data", p.handleRequest)
}

// 注册插件
pluginManager.Register(myPlugin.New())
```

📖 **详细文档**: [../doc/插件系统.md](../doc/插件系统.md)

### 5. 配置系统

**关键文件**:
- `internal/config/config.go` - 配置管理

**使用方式**:
```go
// 访问配置
cfg := config.GlobalConfig
port := cfg.Port
jwtSecret := cfg.JWTSecret
```

📖 **详细文档**: [../doc/配置系统.md](../doc/配置系统.md)

### 6. API 路由

**关键文件**:
- `routes/routes.go` - 路由定义

**使用方式**:
```go
// 定义路由
api := router.Group("/api")
{
    api.POST("/login", authCtrl.Login)
    api.GET("/profile", middleware.AuthMiddleware(), getProfile)
}
```

📖 **详细文档**: [../doc/API路由.md](../doc/API路由.md)

---

## 🛠️ 常用工具函数

### 响应封装 (utils/response.go)

```go
// 成功响应
utils.Success(c, data)

// 失败响应
utils.Fail(c, 400, "错误信息")
```

### 密码处理 (utils/password.go)

```go
// 哈希密码
hashedPassword, err := utils.HashPassword(password)

// 验证密码
isValid := utils.CheckPasswordHash(password, hashedPassword)
```

### JWT 工具 (utils/jwt.go)

```go
// 生成Token
token, err := utils.GenerateToken(userID, role)

// 解析Token
claims, err := utils.ParseToken(tokenString)
```

### 邮件发送 (utils/email.go)

```go
// 发送邮件
err := utils.SendEmail(utils.EmailMessage{
    To:      to,
    Subject: subject,
    Body:    body,
})

// 替换模板变量
result := utils.ReplaceTemplateVars(template, vars)
```

---

## 📖 详细文档索引

| 文档 | 路径 | 内容 |
|------|------|------|
| JWT认证 | `../doc/JWT认证.md` | Token生成、验证、刷新 |
| 邮件系统 | `../doc/邮件系统.md` | SMTP配置、邮件发送、模板 |
| 数据库模型 | `../doc/数据库模型.md` | 表结构、CRUD操作 |
| 插件系统 | `../doc/插件系统.md` | 插件接口、注册、开发 |
| 配置系统 | `../doc/配置系统.md` | 环境变量、配置加载 |
| API路由 | `../doc/API路由.md` | 路由定义、中间件 |
| 前端请求 | `../doc/前端请求.md` | 前端API调用（参考） |

---

## ⚠️ 开发注意事项

1. **使用统一响应**: 始终使用 `utils.Success` 和 `utils.Fail`
2. **错误处理**: 不要忽略错误，始终返回有意义的错误信息
3. **数据库操作**: 使用模型方法，不要直接执行 SQL
4. **Token安全**: 生产环境必须修改默认 JWT 密钥
5. **邮件发送**: 开发模式可以打印验证码到日志

---

> 💡 **提示**: 开发新功能前请先阅读对应的详细文档。
