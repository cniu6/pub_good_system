# é‚®ä»¶ç³»ç»Ÿ - å®Œæ•´ä½¿ç”¨æŒ‡å—

> ğŸ“§ **æ–‡æ¡£ä½ç½®**: `doc/é‚®ä»¶ç³»ç»Ÿ.md`
> 
> **å…³è”æ–‡ä»¶**:
> - `backend/utils/email.go` - é‚®ä»¶å‘é€æ ¸å¿ƒä»£ç 
> - `backend/app/models/email.go` - é‚®ä»¶æ¨¡æ¿å’Œæ—¥å¿—æ¨¡å‹
> - `backend/internal/config/config.go` - SMTPé…ç½®

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
3. [å‘é€é‚®ä»¶](#å‘é€é‚®ä»¶)
4. [é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ](#é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ)
5. [é‚®ä»¶æ—¥å¿—](#é‚®ä»¶æ—¥å¿—)
6. [å¸¸è§ä½¿ç”¨åœºæ™¯](#å¸¸è§ä½¿ç”¨åœºæ™¯)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é‚®ä»¶å‘é€æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Controller  â”€â”€â–º  utils.SendEmail()  â”€â”€â–º  SMTP Server       â”‚
â”‚       â”‚                                               â”‚      â”‚
â”‚       â–¼                                               â–¼      â”‚
â”‚  models.GetEmailTemplate()                     Email Logs   â”‚
â”‚       â”‚                                               â”‚      â”‚
â”‚       â–¼                                               â–¼      â”‚
â”‚  ReplaceTemplateVars()                    (å¼‚æ­¥å†™å…¥DB)      â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®è¯´æ˜

### å¿…éœ€çš„ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹ SMTP å‚æ•°ï¼š

```env
# SMTP æœåŠ¡å™¨é…ç½®
SMTP_HOST=smtp.gmail.com          # SMTPæœåŠ¡å™¨åœ°å€
SMTP_PORT=587                     # SMTPç«¯å£ (25/587/465)
SMTP_USERNAME=your-email@gmail.com # ç™»å½•ç”¨æˆ·å
SMTP_PASSWORD=your-app-password   # ç™»å½•å¯†ç /åº”ç”¨ä¸“ç”¨å¯†ç 
SMTP_SSL_TYPE=ssl                 # SSLç±»å‹: ssl æˆ– ç•™ç©º

# å‘ä»¶äººé…ç½®ï¼ˆå¯é€‰ï¼‰
SYSTEM_EMAIL_ADDRESS=noreply@yourapp.com  # å‘ä»¶äººé‚®ç®±
SYSTEM_EMAIL_NAME=YourAppName             # å‘ä»¶äººåç§°
```

### é…ç½®åŠ è½½

é…ç½®åœ¨ `backend/internal/config/config.go` ä¸­å®šä¹‰ï¼š

```go
type Config struct {
    SMTPHost        string  // SMTPæœåŠ¡å™¨
    SMTPPort        string  // ç«¯å£
    SMTPUser        string  // ç”¨æˆ·å
    SMTPPass        string  // å¯†ç 
    SMTPSSL         bool    // æ˜¯å¦ä½¿ç”¨SSL
    SystemEmail     string  // ç³»ç»Ÿå‘ä»¶é‚®ç®±
    SystemEmailName string  // ç³»ç»Ÿå‘ä»¶äººåç§°
}
```

### æ”¯æŒçš„é‚®ä»¶æœåŠ¡å•†é…ç½®

#### Gmail
```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SSL_TYPE=  # ç•™ç©ºï¼Œä½¿ç”¨STARTTLS
```

#### QQé‚®ç®±
```env
SMTP_HOST=smtp.qq.com
SMTP_PORT=465
SMTP_SSL_TYPE=ssl
```

#### 163é‚®ç®±
```env
SMTP_HOST=smtp.163.com
SMTP_PORT=465
SMTP_SSL_TYPE=ssl
```

#### Outlook
```env
SMTP_HOST=smtp.office365.com
SMTP_PORT=587
SMTP_SSL_TYPE=  # ç•™ç©º
```

#### é˜¿é‡Œäº‘ä¼ä¸šé‚®ç®±
```env
SMTP_HOST=smtp.mxhichina.com
SMTP_PORT=465
SMTP_SSL_TYPE=ssl
```

---

## å‘é€é‚®ä»¶

### åŸºç¡€ API

**æ–‡ä»¶**: `backend/utils/email.go`

```go
// EmailMessage é‚®ä»¶å†…å®¹ç»“æ„ä½“
type EmailMessage struct {
    To      string  // æ”¶ä»¶äººé‚®ç®±
    Subject string  // é‚®ä»¶ä¸»é¢˜
    Body    string  // é‚®ä»¶å†…å®¹ï¼ˆæ”¯æŒHTMLï¼‰
}

// SendEmail å‘é€é‚®ä»¶ï¼ˆè‡ªåŠ¨æ ¹æ®é…ç½®é€‰æ‹©SSLæˆ–éSSLï¼‰
func SendEmail(msg EmailMessage) error
```

### åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

```go
package controllers

import (
    "fst/backend/utils"
    "fst/backend/internal/config"
)

func (ctrl *YourController) SendNotification(c *gin.Context) {
    // æ£€æŸ¥SMTPé…ç½®
    if config.GlobalConfig.SMTPHost == "" {
        utils.Fail(c, 500, "SMTP not configured")
        return
    }
    
    // æ„é€ é‚®ä»¶
    msg := utils.EmailMessage{
        To:      "user@example.com",
        Subject: "æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡",
        Body:    "<h1>æ„Ÿè°¢æ‚¨çš„æ³¨å†Œ</h1><p>è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶</p>",
    }
    
    // å‘é€
    if err := utils.SendEmail(msg); err != nil {
        utils.Fail(c, 500, "Failed to send email: "+err.Error())
        return
    }
    
    utils.Success(c, gin.H{"message": "Email sent successfully"})
}
```

### å‘é€HTMLé‚®ä»¶

```go
htmlBody := `
<!DOCTYPE html>
<html>
<head>
    <style>
        .container { padding: 20px; font-family: Arial, sans-serif; }
        .code { font-size: 24px; color: #1890ff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h2>éªŒè¯ç </h2>
        <p>æ‚¨çš„éªŒè¯ç æ˜¯ï¼š</p>
        <p class="code">123456</p>
        <p>æœ‰æ•ˆæœŸ5åˆ†é’Ÿ</p>
    </div>
</body>
</html>
`

err := utils.SendEmail(utils.EmailMessage{
    To:      "user@example.com",
    Subject: "ã€AppNameã€‘æ‚¨çš„éªŒè¯ç ",
    Body:    htmlBody,
})
```

---

## é‚®ä»¶æ¨¡æ¿ç³»ç»Ÿ

### æ¨¡æ¿è¡¨ç»“æ„

**æ–‡ä»¶**: `backend/app/models/email.go`

```go
type EmailTemplate struct {
    ID          uint64    `db:"id" json:"id"`
    Name        string    `db:"name" json:"name"`           // æ¨¡æ¿æ ‡è¯†å
    Lang        string    `db:"lang" json:"lang"`           // è¯­è¨€ä»£ç  (zh-CN/en-US)
    Title       string    `db:"title" json:"title"`         // æ¨¡æ¿æ ‡é¢˜
    Subject     string    `db:"subject" json:"subject"`     // é‚®ä»¶ä¸»é¢˜
    Content     string    `db:"content" json:"content"`     // é‚®ä»¶å†…å®¹
    Description string    `db:"description" json:"description"` // æè¿°
    Variables   string    `db:"variables" json:"variables"` // å¯ç”¨å˜é‡è¯´æ˜
    Status      int       `db:"status" json:"status"`       // çŠ¶æ€ (0ç¦ç”¨/1å¯ç”¨)
    CreatedAt   time.Time `db:"created_at" json:"created_at"`
    UpdatedAt   time.Time `db:"updated_at" json:"updated_at"`
}
```

### æ¨¡æ¿æ“ä½œæ–¹æ³•

```go
// åˆ›å»ºæ¨¡æ¿
func CreateEmailTemplate(tpl *EmailTemplate) error

// è·å–æ¨¡æ¿ï¼ˆè‡ªåŠ¨å›é€€åˆ° zh-CNï¼‰
func GetEmailTemplate(name, lang string) (*EmailTemplate, error)

// æ£€æŸ¥æ¨¡æ¿æ˜¯å¦å­˜åœ¨
func EmailTemplateExists(name, lang string) (bool, error)

// åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿ï¼ˆåœ¨ main.go å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
func InitEmailTemplates()
```

### å†…ç½®æ¨¡æ¿

ç³»ç»Ÿå¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–ä»¥ä¸‹æ¨¡æ¿ï¼š

#### 1. æ³¨å†ŒéªŒè¯ç æ¨¡æ¿ (register_code)

**zh-CN**:
```html
<h2>æ¬¢è¿æ³¨å†Œ {app_name}</h2>
<p>æ‚¨çš„éªŒè¯ç æ˜¯ï¼š<strong>{code}</strong></p>
<p>éªŒè¯ç æœ‰æ•ˆæœŸä¸º 5 åˆ†é’Ÿï¼Œè¯·å°½å¿«å®ŒæˆéªŒè¯ã€‚</p>
<p>å¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚</p>
```

**en-US**:
```html
<h2>Welcome to {app_name}</h2>
<p>Your verification code is: <strong>{code}</strong></p>
<p>The code is valid for 5 minutes. Please complete verification soon.</p>
<p>If you did not request this, please ignore this email.</p>
```

**å˜é‡**: `{app_name}`, `{code}`

#### 2. é‡ç½®å¯†ç æ¨¡æ¿ (reset_password)

**zh-CN**:
```html
<h2>å¯†ç é‡ç½®è¯·æ±‚</h2>
<p>æ‚¨æ”¶åˆ°æ­¤é‚®ä»¶æ˜¯å› ä¸ºæœ‰äººè¯·æ±‚é‡ç½®æ‚¨åœ¨ {app_name} çš„è´¦æˆ·å¯†ç ã€‚</p>
<p>è¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥é‡ç½®å¯†ç ï¼š</p>
<p><a href="{link}">{link}</a></p>
<p>æˆ–è€…ä½¿ç”¨éªŒè¯ç ï¼š<strong>{code}</strong></p>
<p>æ­¤é“¾æ¥å’ŒéªŒè¯ç å°†åœ¨ 15 åˆ†é’Ÿåå¤±æ•ˆã€‚</p>
<p>å¦‚éæœ¬äººæ“ä½œï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚</p>
```

**en-US**:
```html
<h2>Password Reset Request</h2>
<p>You received this email because someone requested a password reset for your account at {app_name}.</p>
<p>Please click the link below to reset your password:</p>
<p><a href="{link}">{link}</a></p>
<p>Or use this code: <strong>{code}</strong></p>
<p>This link and code will expire in 15 minutes.</p>
<p>If you did not request this, please ignore this email.</p>
```

**å˜é‡**: `{app_name}`, `{link}`, `{code}`

### ä½¿ç”¨æ¨¡æ¿å‘é€é‚®ä»¶

```go
import (
    "fst/backend/app/models"
    "fst/backend/internal/config"
    "fst/backend/utils"
    "strings"
)

func sendEmailWithTemplate(email, code string) error {
    // è·å–æ¨¡æ¿
    tpl, err := models.GetEmailTemplate("register_code", "zh-CN")
    if err != nil {
        // é™çº§å¤„ç†ï¼šä½¿ç”¨ç¡¬ç¼–ç å†…å®¹
        subject := fmt.Sprintf("ã€%sã€‘æ³¨å†ŒéªŒè¯ç ", config.GlobalConfig.AppName)
        body := fmt.Sprintf("æ‚¨çš„éªŒè¯ç æ˜¯ï¼š%sï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿã€‚", code)
    } else {
        // ä½¿ç”¨æ¨¡æ¿å¹¶æ›¿æ¢å˜é‡
        subject = strings.ReplaceAll(tpl.Subject, "{app_name}", config.GlobalConfig.AppName)
        body = strings.ReplaceAll(tpl.Content, "{code}", code)
        body = strings.ReplaceAll(body, "{app_name}", config.GlobalConfig.AppName)
    }
    
    // å‘é€é‚®ä»¶
    return utils.SendEmail(utils.EmailMessage{
        To:      email,
        Subject: subject,
        Body:    body,
    })
}
```

### æ›¿æ¢æ¨¡æ¿å˜é‡å·¥å…·å‡½æ•°

```go
// ReplaceTemplateVars æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡
// template: "Hello {name}, your code is {code}"
// vars: map[string]string{"name": "John", "code": "123456"}
// è¿”å›: "Hello John, your code is 123456"
func ReplaceTemplateVars(template string, vars map[string]string) string
```

**ä½¿ç”¨ç¤ºä¾‹**:
```go
template := "Hello {username}, welcome to {app_name}!"
vars := map[string]string{
    "username": "John",
    "app_name": "MyApp",
}
result := utils.ReplaceTemplateVars(template, vars)
// ç»“æœ: "Hello John, welcome to MyApp!"
```

---

## é‚®ä»¶æ—¥å¿—

### æ—¥å¿—è¡¨ç»“æ„

```go
type EmailLog struct {
    ID           uint64    `db:"id" json:"id"`
    ToEmail      string    `db:"to_email" json:"to_email"`           // æ”¶ä»¶äºº
    Subject      string    `db:"subject" json:"subject"`             // ä¸»é¢˜
    Content      string    `db:"content" json:"content"`             // å†…å®¹
    TemplateName string    `db:"template_name" json:"template_name"` // ä½¿ç”¨çš„æ¨¡æ¿
    Status       int       `db:"status" json:"status"`               // çŠ¶æ€ (0å¤±è´¥/1æˆåŠŸ)
    ErrorMsg     string    `db:"error_msg" json:"error_msg"`         // é”™è¯¯ä¿¡æ¯
    CreatedAt    time.Time `db:"created_at" json:"created_at"`
}
```

### è®°å½•é‚®ä»¶æ—¥å¿—

**é‡è¦**: å§‹ç»ˆå¼‚æ­¥è®°å½•é‚®ä»¶æ—¥å¿—ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹

```go
// è®°å½•é‚®ä»¶æ—¥å¿—ï¼ˆå¼‚æ­¥ï¼‰
go func(email, subj, content string, status int, errMsg string) {
    _ = models.CreateEmailLog(email, subj, content, tplName, status, errMsg)
}(req.Email, subject, body, status, errMsg)
```

### å®Œæ•´çš„å‘é€å¹¶è®°å½•æ—¥å¿—ç¤ºä¾‹

```go
func (ctrl *AuthController) SendCode(c *gin.Context) {
    // ... ç”ŸæˆéªŒè¯ç  ...
    
    // è·å–æ¨¡æ¿å†…å®¹
    tpl, _ := models.GetEmailTemplate("register_code", "zh-CN")
    subject := strings.ReplaceAll(tpl.Subject, "{app_name}", config.GlobalConfig.AppName)
    body := strings.ReplaceAll(tpl.Content, "{code}", code)
    
    // å‘é€é‚®ä»¶
    var err error
    status := 1
    errMsg := ""
    
    if config.GlobalConfig.SMTPHost != "" {
        err = utils.SendEmail(utils.EmailMessage{
            To:      req.Email,
            Subject: subject,
            Body:    body,
        })
        if err != nil {
            status = 0
            errMsg = err.Error()
        }
    }
    
    // å¼‚æ­¥è®°å½•æ—¥å¿—ï¼ˆå…³é”®ï¼ä¸è¦é˜»å¡ï¼‰
    go func(email, subj, content string, st int, em string) {
        _ = models.CreateEmailLog(email, subj, content, "register_code", st, em)
    }(req.Email, subject, body, status, errMsg)
    
    if err != nil {
        utils.Fail(c, 500, "Failed to send email")
        return
    }
    
    utils.Success(c, gin.H{"message": "Code sent"})
}
```

---

## å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å‘é€æ³¨å†ŒéªŒè¯ç 

**æ§åˆ¶å™¨ä»£ç **: `backend/app/controllers/auth_controller.go`

```go
func (ctrl *AuthController) SendRegisterCode(c *gin.Context) {
    var req SendCodeRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        utils.Fail(c, 400, err.Error())
        return
    }
    
    // ç”Ÿæˆ6ä½éªŒè¯ç 
    rnd := rand.New(rand.NewSource(time.Now().UnixNano()))
    code := fmt.Sprintf("%06d", rnd.Intn(1000000))
    
    // å­˜å‚¨éªŒè¯ç ï¼Œ5åˆ†é’Ÿæœ‰æ•ˆæœŸ
    expiresAt := time.Now().Add(5 * time.Minute)
    err := models.CreateVerificationCode(req.Email, code, "register", expiresAt)
    if err != nil {
        utils.Fail(c, 500, "Failed to generate code")
        return
    }
    
    // è·å–è¯­è¨€
    lang := getLangFromRequest(c, req.Lang)
    
    // è·å–æ¨¡æ¿
    tpl, err := models.GetEmailTemplate("register_code", lang)
    var subject, body string
    if err == nil && tpl != nil {
        subject = strings.ReplaceAll(tpl.Subject, "{app_name}", config.GlobalConfig.AppName)
        body = strings.ReplaceAll(tpl.Content, "{code}", code)
        body = strings.ReplaceAll(body, "{app_name}", config.GlobalConfig.AppName)
    } else {
        // é™çº§ä½¿ç”¨é»˜è®¤å†…å®¹
        subject = fmt.Sprintf("ã€%sã€‘æ³¨å†ŒéªŒè¯ç ", config.GlobalConfig.AppName)
        body = fmt.Sprintf("æ‚¨çš„éªŒè¯ç æ˜¯ï¼š%sï¼Œæœ‰æ•ˆæœŸ5åˆ†é’Ÿã€‚", code)
    }
    
    // å‘é€é‚®ä»¶
    if config.GlobalConfig.SMTPHost != "" {
        err := utils.SendEmail(utils.EmailMessage{
            To:      req.Email,
            Subject: subject,
            Body:    body,
        })
        
        // è®°å½•æ—¥å¿—
        status := 1
        errMsg := ""
        if err != nil {
            status = 0
            errMsg = err.Error()
        }
        go func(email, subj, content string, st int, em string) {
            _ = models.CreateEmailLog(email, subj, content, "register_code", st, em)
        }(req.Email, subject, body, status, errMsg)
        
        if err != nil {
            // å¼€å‘æ¨¡å¼è¿”å›éªŒè¯ç ç”¨äºè°ƒè¯•
            if config.GlobalConfig.AppMode == "dev" {
                fmt.Printf("[DEV] Email send failed. Code: %s\n", code)
            }
            utils.Fail(c, 500, "Failed to send email")
            return
        }
    }
    
    utils.Success(c, gin.H{"message": "Verification code sent"})
}
```

### åœºæ™¯ 2: å‘é€å¯†ç é‡ç½®é‚®ä»¶

```go
func (ctrl *AuthController) SendResetEmail(c *gin.Context) {
    var req ResetEmailRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        utils.Fail(c, 400, err.Error())
        return
    }
    
    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
    user, err := models.GetUserByUsernameOrEmail(req.Email)
    if err != nil || user == nil {
        // å®‰å…¨è€ƒè™‘ï¼šå³ä½¿é‚®ç®±ä¸å­˜åœ¨ä¹Ÿè¿”å›æˆåŠŸ
        utils.Success(c, gin.H{"message": "If the email exists, a reset code has been sent"})
        return
    }
    
    // ç”ŸæˆéªŒè¯ç 
    rnd := rand.New(rand.NewSource(time.Now().UnixNano()))
    code := fmt.Sprintf("%06d", rnd.Intn(1000000))
    
    // å­˜å‚¨éªŒè¯ç ï¼Œ15åˆ†é’Ÿæœ‰æ•ˆæœŸ
    expiresAt := time.Now().Add(15 * time.Minute)
    _ = models.CreateVerificationCode(user.Email, code, "reset_password", expiresAt)
    
    // æ„é€ é‡ç½®é“¾æ¥
    frontendURL := config.GlobalConfig.FrontendURL
    if frontendURL == "" {
        frontendURL = "http://localhost:5173"
    }
    resetLink := fmt.Sprintf("%s/#/login/reset-password-confirm?email=%s&token=%s", 
        frontendURL, user.Email, code)
    
    // è·å–æ¨¡æ¿
    lang := getLangFromRequest(c, req.Lang)
    tpl, err := models.GetEmailTemplate("reset_password", lang)
    var subject, body string
    if err == nil && tpl != nil {
        subject = strings.ReplaceAll(tpl.Subject, "{app_name}", config.GlobalConfig.AppName)
        body = strings.ReplaceAll(tpl.Content, "{code}", code)
        body = strings.ReplaceAll(body, "{link}", resetLink)
        body = strings.ReplaceAll(body, "{app_name}", config.GlobalConfig.AppName)
    } else {
        subject = fmt.Sprintf("ã€%sã€‘å¯†ç é‡ç½®è¯·æ±‚", config.GlobalConfig.AppName)
        body = fmt.Sprintf("è¯·ç‚¹å‡»ä»¥ä¸‹é“¾æ¥é‡ç½®å¯†ç ï¼š<br><a href=\"%s\">%s</a><br>æˆ–è€…ä½¿ç”¨éªŒè¯ç ï¼š%s<br>æœ‰æ•ˆæœŸ15åˆ†é’Ÿã€‚",
            resetLink, resetLink, code)
    }
    
    // å‘é€é‚®ä»¶å¹¶è®°å½•æ—¥å¿—
    if config.GlobalConfig.SMTPHost != "" {
        err := utils.SendEmail(utils.EmailMessage{
            To:      user.Email,
            Subject: subject,
            Body:    body,
        })
        
        go func(email, subj, content string, st int, em string) {
            _ = models.CreateEmailLog(email, subj, content, "reset_password", st, em)
        }(user.Email, subject, body, status, errMsg)
        
        if err != nil {
            utils.Fail(c, 500, "Failed to send email")
            return
        }
    }
    
    utils.Success(c, gin.H{"message": "Reset email sent"})
}
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜ 1: é‚®ä»¶å‘é€å¤±è´¥

**ç°è±¡**: `Failed to send email` é”™è¯¯

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ SMTP é…ç½®
```bash
# æŸ¥çœ‹å½“å‰é…ç½®
grep -E "SMTP|EMAIL" .env
```

2. æ£€æŸ¥ç½‘ç»œè¿æ¥
```bash
telnet smtp.gmail.com 587
```

3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
```go
// åœ¨ SendEmail ä¸­æ·»åŠ è°ƒè¯•
fmt.Printf("[DEBUG] SMTP Config: Host=%s, Port=%s, User=%s\n", 
    cfg.SMTPHost, cfg.SMTPPort, cfg.SMTPUser)
```

4. ç¡®è®¤ SSL é…ç½®
- ç«¯å£ 465ï¼šé€šå¸¸éœ€è¦ SSL
- ç«¯å£ 587ï¼šé€šå¸¸ä½¿ç”¨ STARTTLSï¼ŒSSL ç•™ç©º
- ç«¯å£ 25ï¼šé€šå¸¸ä¸ä½¿ç”¨ SSL

### å¸¸è§é—®é¢˜ 2: å‘ä»¶äººæ˜¾ç¤ºä¸æ­£ç¡®

**ç°è±¡**: æ”¶ä»¶äººçœ‹åˆ°çš„å‘ä»¶äººæ˜¯é‚®ç®±åœ°å€è€Œéåç§°

**è§£å†³æ–¹æ¡ˆ**:
```env
# ç¡®ä¿é…ç½®äº†è¿™äº›
SYSTEM_EMAIL_ADDRESS=noreply@yourapp.com
SYSTEM_EMAIL_NAME=YourAppName
```

ä»£ç ä¼šè‡ªåŠ¨ä½¿ç”¨ MIME ç¼–ç å¤„ç†ä¸­æ–‡åç§°ï¼š
```go
encodedName := base64.StdEncoding.EncodeToString([]byte(emailName))
fromHeader := fmt.Sprintf("=?UTF-8?B?%s?= <%s>", encodedName, fromEmail)
```

### å¸¸è§é—®é¢˜ 3: é‚®ä»¶è¿›å…¥åƒåœ¾ç®±

**è§£å†³æ–¹æ¡ˆ**:
1. é…ç½® SPF è®°å½•
2. é…ç½® DKIM ç­¾å
3. ä½¿ç”¨ä¸“ä¸šçš„é‚®ä»¶æœåŠ¡å•†ï¼ˆå¦‚ SendGridã€Mailgunï¼‰
4. åœ¨é‚®ä»¶å†…å®¹ä¸­æ·»åŠ é€€è®¢é“¾æ¥

### å¸¸è§é—®é¢˜ 4: å¼€å‘ç¯å¢ƒæ— æ³•å‘é€é‚®ä»¶

**è§£å†³æ–¹æ¡ˆ**:
```go
// å¼€å‘æ¨¡å¼ä¸‹ç›´æ¥æ‰“å°éªŒè¯ç åˆ°æ—¥å¿—
if config.GlobalConfig.AppMode == "dev" {
    fmt.Printf("[DEV] Verification Code: %s\n", code)
    // æˆ–è€…è¿”å›ç»™å‰ç«¯ï¼ˆä»…ç”¨äºå¼€å‘ï¼‰
    utils.Success(c, gin.H{
        "message": "Development mode: check server logs",
        "code": code, // ä»…å¼€å‘ç¯å¢ƒ
    })
    return
}
```

---

## æœ€ä½³å®è·µ

### âœ… Do's

1. **æ€»æ˜¯æ£€æŸ¥ SMTP é…ç½®**
```go
if config.GlobalConfig.SMTPHost == "" {
    return fmt.Errorf("SMTP not configured")
}
```

2. **å¼‚æ­¥è®°å½•é‚®ä»¶æ—¥å¿—**
```go
go func() {
    _ = models.CreateEmailLog(...)
}()
```

3. **ä½¿ç”¨æ¨¡æ¿ç³»ç»Ÿ**
- æ˜“äºç»´æŠ¤
- æ”¯æŒå¤šè¯­è¨€
- å†…å®¹å’Œä»£ç åˆ†ç¦»

4. **æä¾›é™çº§æ–¹æ¡ˆ**
```go
tpl, err := models.GetEmailTemplate(name, lang)
if err != nil {
    // ä½¿ç”¨é»˜è®¤ç¡¬ç¼–ç å†…å®¹
}
```

5. **å®‰å…¨è€ƒè™‘**
- ä¸æ³„éœ²é‚®ç®±æ˜¯å¦å­˜åœ¨
- éªŒè¯ç æœ‰æ—¶æ•ˆæ€§
- ç”Ÿäº§ç¯å¢ƒä¸æš´éœ²éªŒè¯ç åˆ°æ—¥å¿—

### âŒ Don'ts

1. **ä¸è¦åŒæ­¥è®°å½•æ—¥å¿—**
```go
// é”™è¯¯
models.CreateEmailLog(...) // é˜»å¡å‘é€æµç¨‹

// æ­£ç¡®
go func() {
    models.CreateEmailLog(...)
}()
```

2. **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæš´éœ²éªŒè¯ç **
```go
// é”™è¯¯
utils.Success(c, gin.H{"code": code})

// æ­£ç¡®
utils.Success(c, gin.H{"message": "Code sent"})
```

3. **ä¸è¦ç¡¬ç¼–ç é‚®ä»¶å†…å®¹**
```go
// é”™è¯¯
body := "æ‚¨çš„éªŒè¯ç æ˜¯ï¼š123456"

// æ­£ç¡®
tpl, _ := models.GetEmailTemplate("register_code", lang)
body = strings.ReplaceAll(tpl.Content, "{code}", code)
```

4. **ä¸è¦å¿½ç•¥é”™è¯¯å¤„ç†**
```go
// é”™è¯¯
_ = utils.SendEmail(msg)

// æ­£ç¡®
if err := utils.SendEmail(msg); err != nil {
    log.Printf("Failed to send email: %v", err)
    return err
}
```

---

## API å‚è€ƒ

### utils/email.go

| å‡½æ•° | ç­¾å | è¯´æ˜ |
|------|------|------|
| SendEmail | `func SendEmail(msg EmailMessage) error` | å‘é€é‚®ä»¶ï¼ˆè‡ªåŠ¨SSLæ£€æµ‹ï¼‰ |
| ReplaceTemplateVars | `func ReplaceTemplateVars(template string, vars map[string]string) string` | æ›¿æ¢æ¨¡æ¿å˜é‡ |

### models/email.go

| å‡½æ•° | ç­¾å | è¯´æ˜ |
|------|------|------|
| CreateEmailLog | `func CreateEmailLog(to, subject, content, tplName string, status int, errorMsg string) error` | åˆ›å»ºé‚®ä»¶æ—¥å¿— |
| CreateEmailTemplate | `func CreateEmailTemplate(tpl *EmailTemplate) error` | åˆ›å»ºé‚®ä»¶æ¨¡æ¿ |
| GetEmailTemplate | `func GetEmailTemplate(name, lang string) (*EmailTemplate, error)` | è·å–æ¨¡æ¿ |
| EmailTemplateExists | `func EmailTemplateExists(name, lang string) (bool, error)` | æ£€æŸ¥æ¨¡æ¿å­˜åœ¨ |
| InitEmailTemplates | `func InitEmailTemplates()` | åˆå§‹åŒ–é»˜è®¤æ¨¡æ¿ |

---

## æ‰©å±•é˜…è¯»

- [Go smtp åŒ…æ–‡æ¡£](https://golang.org/pkg/net/smtp/)
- [Go tls åŒ…æ–‡æ¡£](https://golang.org/pkg/crypto/tls/)
- [MIME ç¼–ç è§„èŒƒ](https://tools.ietf.org/html/rfc2047)

---

> ğŸ“ **æœ€åæ›´æ–°**: 2026-02-04
> 
> å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒ `backend/utils/email.go` å’Œ `backend/app/models/email.go` æºä»£ç ã€‚
