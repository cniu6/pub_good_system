# æ’ä»¶ç³»ç»Ÿ - å®Œæ•´ä½¿ç”¨æŒ‡å—

> ğŸ”Œ **æ–‡æ¡£ä½ç½®**: `doc/æ’ä»¶ç³»ç»Ÿ.md`
> 
> **å…³è”æ–‡ä»¶**:
> - `backend/app/plugins/interface.go` - æ’ä»¶æ¥å£å®šä¹‰
> - `backend/app/plugins/demo/plugin.go` - ç¤ºä¾‹æ’ä»¶
> - `backend/cmd/main.go` - æ’ä»¶åŠ è½½å…¥å£

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ’ä»¶æ¥å£](#æ’ä»¶æ¥å£)
3. [åˆ›å»ºæ’ä»¶](#åˆ›å»ºæ’ä»¶)
4. [æ³¨å†Œæ’ä»¶](#æ³¨å†Œæ’ä»¶)
5. [æ’ä»¶ç”Ÿå‘½å‘¨æœŸ](#æ’ä»¶ç”Ÿå‘½å‘¨æœŸ)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
7. [ç¤ºä¾‹æ’ä»¶è¯¦è§£](#ç¤ºä¾‹æ’ä»¶è¯¦è§£)

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ’ä»¶ç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                   PluginManager                       â”‚     â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚   â”‚  â”‚  Plugin A   â”‚  â”‚  Plugin B   â”‚  â”‚  Plugin C   â”‚   â”‚     â”‚
â”‚   â”‚  â”‚  - Name()   â”‚  â”‚  - Name()   â”‚  â”‚  - Name()   â”‚   â”‚     â”‚
â”‚   â”‚  â”‚  - Init()   â”‚  â”‚  - Init()   â”‚  â”‚  - Init()   â”‚   â”‚     â”‚
â”‚   â”‚  â”‚  - Routes() â”‚  â”‚  - Routes() â”‚  â”‚  - Routes() â”‚   â”‚     â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚   Gin Router     â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| Plugin æ¥å£ | `interface.go` | æ‰€æœ‰æ’ä»¶å¿…é¡»å®ç°çš„æ¥å£ |
| PluginManager | `interface.go` | æ’ä»¶ç®¡ç†å™¨ï¼Œè´Ÿè´£æ³¨å†Œå’Œç®¡ç†æ’ä»¶ |
| å…·ä½“æ’ä»¶ | `demo/plugin.go` | å®ç° Plugin æ¥å£çš„å…·ä½“æ’ä»¶ |

---

## æ’ä»¶æ¥å£

### æ¥å£å®šä¹‰

**æ–‡ä»¶**: `backend/app/plugins/interface.go`

```go
package plugins

import "github.com/gin-gonic/gin"

// Plugin æ˜¯æ‰€æœ‰æ’ä»¶å¿…é¡»å®ç°çš„æ¥å£
type Plugin interface {
    // Name è¿”å›æ’ä»¶çš„å”¯ä¸€åç§°
    // è¦æ±‚ï¼šå…¨å±€å”¯ä¸€ï¼Œä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
    Name() string
    
    // Version è¿”å›æ’ä»¶ç‰ˆæœ¬
    // æ ¼å¼ï¼šsemver (å¦‚ "1.0.0")
    Version() string
    
    // Init åˆå§‹åŒ–æ’ä»¶
    // ç”¨é€”ï¼šæ•°æ®åº“è¿ç§»ã€é…ç½®åŠ è½½ã€èµ„æºåˆå§‹åŒ–
    // æ³¨æ„ï¼šè¯¥æ–¹æ³•åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå¤±è´¥ä¼šé˜»æ­¢åº”ç”¨å¯åŠ¨
    Init() error
    
    // RegisterRoutes æ³¨å†Œæ’ä»¶è·¯ç”±
    // å‚æ•°ï¼šrouter æ˜¯æ’ä»¶ä¸“å±çš„è·¯ç”±ç»„
    // è·¯å¾„æ ¼å¼ï¼š/api/plugins/{plugin_name}/...
    RegisterRoutes(router *gin.RouterGroup)
}

// PluginManager ç®¡ç†æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶
type PluginManager struct {
    plugins map[string]Plugin
}

// NewPluginManager åˆ›å»ºæ–°çš„æ’ä»¶ç®¡ç†å™¨
func NewPluginManager() *PluginManager

// Register æ³¨å†Œæ’ä»¶
// æ³¨æ„ï¼šå¦‚æœåŒåæ’ä»¶å·²å­˜åœ¨ï¼Œä¼šè¢«è¦†ç›–
func (pm *PluginManager) Register(p Plugin)

// GetPlugins è·å–æ‰€æœ‰å·²æ³¨å†Œæ’ä»¶
func (pm *PluginManager) GetPlugins() map[string]Plugin
```

### æ¥å£æ–¹æ³•è¯¦è§£

#### 1. Name()

```go
func (p *YourPlugin) Name() string {
    return "your_plugin_name"  // å¿…é¡»å”¯ä¸€
}
```

**å‘½åè§„èŒƒ**:
- ä½¿ç”¨å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿
- å…¨å±€å”¯ä¸€
- ç®€çŸ­æ˜äº†
- ç¤ºä¾‹: `user_center`, `payment_gateway`, `data_export`

#### 2. Version()

```go
func (p *YourPlugin) Version() string {
    return "1.0.0"  // éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬
}
```

#### 3. Init()

```go
func (p *YourPlugin) Init() error {
    // 1. æ•°æ®åº“è¿ç§»
    if err := p.migrateDB(); err != nil {
        return fmt.Errorf("db migration failed: %w", err)
    }
    
    // 2. åŠ è½½é…ç½®
    p.config = loadConfig()
    
    // 3. åˆå§‹åŒ–èµ„æº
    p.client = createAPIClient()
    
    return nil
}
```

**ç”¨é€”**:
- æ•°æ®åº“è¡¨åˆ›å»º/è¿ç§»
- é…ç½®æ–‡ä»¶åŠ è½½
- å¤–éƒ¨æœåŠ¡è¿æ¥åˆå§‹åŒ–
- ç¼“å­˜é¢„çƒ­

#### 4. RegisterRoutes()

```go
func (p *YourPlugin) RegisterRoutes(router *gin.RouterGroup) {
    // æ³¨å†Œè·¯ç”±
    router.GET("/info", p.getInfo)
    router.POST("/action", p.doAction)
    
    // å­è·¯ç”±ç»„
    api := router.Group("/api")
    {
        api.GET("/list", p.getList)
        api.POST("/create", p.createItem)
    }
}
```

**è·¯ç”±å‰ç¼€**:
- æ’ä»¶è·¯ç”±è‡ªåŠ¨æŒ‚è½½åˆ° `/api/plugins/{plugin_name}/`
- ä¾‹å¦‚æ’ä»¶ `demo` çš„è·¯ç”± `/info` å®é™…è·¯å¾„æ˜¯ `/api/plugins/demo/info`

---

## åˆ›å»ºæ’ä»¶

### æ­¥éª¤ 1: åˆ›å»ºæ’ä»¶ç›®å½•

```bash
mkdir -p backend/app/plugins/your_plugin
```

### æ­¥éª¤ 2: åˆ›å»ºæ’ä»¶æ–‡ä»¶

**æ–‡ä»¶**: `backend/app/plugins/your_plugin/plugin.go`

```go
package your_plugin

import (
    "fmt"
    "net/http"
    
    "github.com/gin-gonic/gin"
    "fst/backend/internal/db"
)

// Plugin æ’ä»¶ç»“æ„ä½“
type Plugin struct {
    config *Config
}

// Config æ’ä»¶é…ç½®
type Config struct {
    Enabled bool   `json:"enabled"`
    APIKey  string `json:"api_key"`
}

// ç¡®ä¿å®ç°äº† Plugin æ¥å£
var _ plugins.Plugin = (*Plugin)(nil)

// New åˆ›å»ºæ’ä»¶å®ä¾‹
func New() *Plugin {
    return &Plugin{}
}

// Name æ’ä»¶åç§°
func (p *Plugin) Name() string {
    return "your_plugin"
}

// Version æ’ä»¶ç‰ˆæœ¬
func (p *Plugin) Version() string {
    return "1.0.0"
}

// Init åˆå§‹åŒ–
func (p *Plugin) Init() error {
    // æ•°æ®åº“è¿ç§»
    if err := p.migrate(); err != nil {
        return err
    }
    
    // åŠ è½½é…ç½®
    p.config = &Config{
        Enabled: true,
        APIKey:  "default-key",
    }
    
    fmt.Printf("Plugin '%s' v%s initialized\n", p.Name(), p.Version())
    return nil
}

// migrate æ•°æ®åº“è¿ç§»
func (p *Plugin) migrate() error {
    query := `
        CREATE TABLE IF NOT EXISTS plugin_your_data (
            id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            value TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
    `
    _, err := db.DB.Exec(query)
    return err
}

// RegisterRoutes æ³¨å†Œè·¯ç”±
func (p *Plugin) RegisterRoutes(router *gin.RouterGroup) {
    router.GET("/info", p.getInfo)
    router.GET("/data", p.getData)
    router.POST("/data", p.createData)
}

// getInfo è·å–æ’ä»¶ä¿¡æ¯
func (p *Plugin) getInfo(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "name":    p.Name(),
        "version": p.Version(),
        "status":  "running",
    })
}

// getData è·å–æ•°æ®
func (p *Plugin) getData(c *gin.Context) {
    var data []map[string]interface{}
    err := db.DB.Select(&data, "SELECT * FROM plugin_your_data")
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    c.JSON(http.StatusOK, data)
}

// createData åˆ›å»ºæ•°æ®
func (p *Plugin) createData(c *gin.Context) {
    var req struct {
        Name  string `json:"name" binding:"required"`
        Value string `json:"value"`
    }
    
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }
    
    result, err := db.DB.Exec(
        "INSERT INTO plugin_your_data (name, value) VALUES (?, ?)",
        req.Name, req.Value,
    )
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    
    id, _ := result.LastInsertId()
    c.JSON(http.StatusOK, gin.H{
        "id":      id,
        "name":    req.Name,
        "value":   req.Value,
        "message": "Created successfully",
    })
}
```

### æ­¥éª¤ 3: æ³¨å†Œæ’ä»¶

**æ–‡ä»¶**: `backend/cmd/main.go`

```go
package main

import (
    // ... å…¶ä»–å¯¼å…¥
    "fst/backend/app/plugins"
    "fst/backend/app/plugins/demo"
    "fst/backend/app/plugins/your_plugin"  // å¯¼å…¥ä½ çš„æ’ä»¶
)

func main() {
    // ... åˆå§‹åŒ–ä»£ç 
    
    // åˆ›å»ºæ’ä»¶ç®¡ç†å™¨
    pluginManager := plugins.NewPluginManager()
    
    // æ³¨å†Œæ’ä»¶
    pluginManager.Register(demo.New())
    pluginManager.Register(your_plugin.New())  // æ³¨å†Œä½ çš„æ’ä»¶
    
    // åˆå§‹åŒ–æ‰€æœ‰æ’ä»¶
    for name, plugin := range pluginManager.GetPlugins() {
        if err := plugin.Init(); err != nil {
            log.Fatalf("Failed to initialize plugin '%s': %v", name, err)
        }
    }
    
    // è®¾ç½®è·¯ç”±
    router := gin.Default()
    
    // æ³¨å†Œæ’ä»¶è·¯ç”±
    for _, plugin := range pluginManager.GetPlugins() {
        group := router.Group("/api/plugins/" + plugin.Name())
        plugin.RegisterRoutes(group)
    }
    
    // ... å¯åŠ¨æœåŠ¡å™¨
}
```

---

## æ³¨å†Œæ’ä»¶

### å®Œæ•´æ³¨å†Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ›å»ºæ’ä»¶    â”‚â”€â”€â”€â”€â–ºâ”‚   å¯¼å…¥æ’ä»¶    â”‚â”€â”€â”€â”€â–ºâ”‚   æ³¨å†Œæ’ä»¶    â”‚
â”‚  NewPlugin() â”‚     â”‚  import pkg  â”‚     â”‚  Register()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯åŠ¨åº”ç”¨     â”‚â—„â”€â”€â”€â”€â”‚  æ³¨å†Œè·¯ç”±     â”‚â—„â”€â”€â”€â”€â”‚  åˆå§‹åŒ–æ’ä»¶   â”‚
â”‚  router.Run  â”‚     â”‚  Routes()    â”‚     â”‚  Init()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ³¨å†Œä»£ç æ¨¡æ¿

**æ–‡ä»¶**: `backend/cmd/main.go`

```go
func setupPlugins(router *gin.Engine) *plugins.PluginManager {
    // åˆ›å»ºç®¡ç†å™¨
    pm := plugins.NewPluginManager()
    
    // ========== æ³¨å†Œæ’ä»¶ ==========
    // æ ¸å¿ƒæ’ä»¶ï¼ˆæŒ‰ä¾èµ–é¡ºåºæ³¨å†Œï¼‰
    pm.Register(demo.New())
    
    // ä¸šåŠ¡æ’ä»¶
    // pm.Register(user_center.New())
    // pm.Register(payment_gateway.New())
    // pm.Register(data_export.New())
    
    // ========== åˆå§‹åŒ–æ’ä»¶ ==========
    log.Println("Initializing plugins...")
    for name, plugin := range pm.GetPlugins() {
        if err := plugin.Init(); err != nil {
            log.Fatalf("Failed to initialize plugin '%s': %v", name, err)
        }
        log.Printf("âœ“ Plugin '%s' v%s initialized", name, plugin.Version())
    }
    
    // ========== æ³¨å†Œè·¯ç”± ==========
    log.Println("Registering plugin routes...")
    for _, plugin := range pm.GetPlugins() {
        group := router.Group("/api/plugins/" + plugin.Name())
        plugin.RegisterRoutes(group)
        log.Printf("âœ“ Routes registered: /api/plugins/%s/*", plugin.Name())
    }
    
    return pm
}
```

---

## æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

### ç”Ÿå‘½å‘¨æœŸå›¾

```
    åˆ›å»º
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®ä¾‹åŒ–      â”‚  New()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å¤±è´¥
â”‚   åˆå§‹åŒ–     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åº”ç”¨å¯åŠ¨å¤±è´¥
â”‚   Init()    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ æˆåŠŸ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿è¡Œä¸­      â”‚  å¤„ç†è¯·æ±‚
â”‚  Running    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…³é—­      â”‚  æ¸…ç†èµ„æºï¼ˆå¦‚éœ€å®ç°ï¼‰
â”‚  Shutdown   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„é˜¶æ®µè¯¦è§£

#### 1. å®ä¾‹åŒ–é˜¶æ®µ

```go
// main.go ä¸­è°ƒç”¨
plugin := your_plugin.New()  // åˆ›å»ºå®ä¾‹
pm.Register(plugin)          // æ³¨å†Œåˆ°ç®¡ç†å™¨
```

**æ³¨æ„äº‹é¡¹**:
- ä¸è¦åœ¨æ­¤é˜¶æ®µè¿›è¡Œè€—æ—¶æ“ä½œ
- åªè¿›è¡Œç®€å•çš„ç»“æ„ä½“åˆå§‹åŒ–
- é…ç½®å»¶è¿Ÿåˆ° Init() åŠ è½½

#### 2. åˆå§‹åŒ–é˜¶æ®µ

```go
func (p *Plugin) Init() error {
    // 1. é…ç½®åŠ è½½
    p.loadConfig()
    
    // 2. æ•°æ®åº“è¿ç§»
    if err := p.migrate(); err != nil {
        return err
    }
    
    // 3. è¿æ¥å¤–éƒ¨æœåŠ¡
    if err := p.connectServices(); err != nil {
        return err
    }
    
    return nil
}
```

**æ³¨æ„äº‹é¡¹**:
- å¤±è´¥ä¼šé˜»æ­¢æ•´ä¸ªåº”ç”¨å¯åŠ¨
- ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²å°±ç»ª
- ä½¿ç”¨è¶…æ—¶æœºåˆ¶é¿å…é˜»å¡

#### 3. è¿è¡Œé˜¶æ®µ

```go
func (p *Plugin) RegisterRoutes(router *gin.RouterGroup) {
    router.GET("/api/data", p.handleRequest)
}

func (p *Plugin) handleRequest(c *gin.Context) {
    // å¤„ç†è¯·æ±‚
}
```

#### 4. å…³é—­é˜¶æ®µï¼ˆå¯é€‰å®ç°ï¼‰

å¦‚æœéœ€è¦å®ç°å…³é—­å›è°ƒï¼Œå¯ä»¥æ‰©å±•æ¥å£ï¼š

```go
// æ‰©å±•æ¥å£
type Shutdownable interface {
    Shutdown() error
}

// åœ¨ main.go ä¸­è°ƒç”¨
func shutdownPlugins(pm *plugins.PluginManager) {
    for name, plugin := range pm.GetPlugins() {
        if s, ok := plugin.(Shutdownable); ok {
            if err := s.Shutdown(); err != nil {
                log.Printf("Failed to shutdown plugin '%s': %v", name, err)
            }
        }
    }
}
```

---

## æœ€ä½³å®è·µ

### 1. æ’ä»¶ç›®å½•ç»“æ„

```
backend/app/plugins/
â”œâ”€â”€ your_plugin/
â”‚   â”œâ”€â”€ plugin.go      # ä¸»æ–‡ä»¶ï¼Œå®ç° Plugin æ¥å£
â”‚   â”œâ”€â”€ handlers.go    # HTTP å¤„ç†å‡½æ•°
â”‚   â”œâ”€â”€ models.go      # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ service.go     # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ config.go      # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ README.md      # æ’ä»¶æ–‡æ¡£
â”œâ”€â”€ another_plugin/
â”‚   â””â”€â”€ ...
â””â”€â”€ interface.go       # æ’ä»¶æ¥å£å®šä¹‰
```

### 2. é”™è¯¯å¤„ç†

```go
func (p *Plugin) Init() error {
    // ä½¿ç”¨ fmt.Errorf åŒ…è£…é”™è¯¯
    if err := p.migrate(); err != nil {
        return fmt.Errorf("database migration failed: %w", err)
    }
    
    return nil
}

func (p *Plugin) handleRequest(c *gin.Context) {
    result, err := p.service.DoSomething()
    if err != nil {
        // ç»Ÿä¸€é”™è¯¯å“åº”
        c.JSON(http.StatusInternalServerError, gin.H{
            "error": "Internal server error",
            "code": "PLUGIN_ERROR",
        })
        return
    }
    
    c.JSON(http.StatusOK, result)
}
```

### 3. æ•°æ®åº“è¡¨å‘½å

```go
// ä½¿ç”¨æ’ä»¶åå‰ç¼€é¿å…å†²çª
const tableName = "plugin_your_data"

// è¿ç§»å‡½æ•°
func (p *Plugin) migrate() error {
    query := fmt.Sprintf(`
        CREATE TABLE IF NOT EXISTS %s (
            id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            -- å…¶ä»–å­—æ®µ
        )
    `, tableName)
    _, err := db.DB.Exec(query)
    return err
}
```

### 4. é…ç½®ç®¡ç†

```go
type Config struct {
    Enabled     bool          `json:"enabled"`      // æ˜¯å¦å¯ç”¨
    MaxRetries  int           `json:"max_retries"`  // æœ€å¤§é‡è¯•æ¬¡æ•°
    Timeout     time.Duration `json:"timeout"`      // è¶…æ—¶æ—¶é—´
    APIKey      string        `json:"api_key"`      // APIå¯†é’¥
}

func (p *Plugin) loadConfig() *Config {
    return &Config{
        Enabled:    getBoolEnv("PLUGIN_YOUR_ENABLED", true),
        MaxRetries: getIntEnv("PLUGIN_YOUR_MAX_RETRIES", 3),
        Timeout:    getDurationEnv("PLUGIN_YOUR_TIMEOUT", 30*time.Second),
        APIKey:     os.Getenv("PLUGIN_YOUR_API_KEY"),
    }
}
```

### 5. æ—¥å¿—è§„èŒƒ

```go
func (p *Plugin) Init() error {
    log.Printf("[%s] Initializing plugin v%s...", p.Name(), p.Version())
    
    // ... åˆå§‹åŒ–ä»£ç 
    
    log.Printf("[%s] Plugin initialized successfully", p.Name())
    return nil
}

func (p *Plugin) handleRequest(c *gin.Context) {
    log.Printf("[%s] Handling request: %s %s", p.Name(), c.Request.Method, c.Request.URL.Path)
    
    // ... å¤„ç†é€»è¾‘
    
    log.Printf("[%s] Request completed in %v", p.Name(), duration)
}
```

### 6. ä½¿ç”¨ä¸­é—´ä»¶

```go
func (p *Plugin) RegisterRoutes(router *gin.RouterGroup) {
    // æ’ä»¶çº§åˆ«çš„ä¸­é—´ä»¶
    router.Use(p.loggingMiddleware())
    router.Use(p.authMiddleware())
    
    router.GET("/public", p.publicHandler)  // å…¬å¼€æ¥å£
    
    // éœ€è¦è®¤è¯çš„æ¥å£
    auth := router.Group("/")
    auth.Use(middleware.AuthMiddleware())
    {
        auth.GET("/private", p.privateHandler)
    }
}

func (p *Plugin) loggingMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        start := time.Now()
        c.Next()
        
        log.Printf("[%s] %s %s %d %v",
            p.Name(),
            c.Request.Method,
            c.Request.URL.Path,
            c.Writer.Status(),
            time.Since(start),
        )
    }
}
```

---

## ç¤ºä¾‹æ’ä»¶è¯¦è§£

### Demo æ’ä»¶æºç 

**æ–‡ä»¶**: `backend/app/plugins/demo/plugin.go`

```go
package demo

import (
    "fmt"
    "net/http"
    
    "github.com/gin-gonic/gin"
    "fst/backend/internal/db"
)

// DemoPlugin æ¼”ç¤ºæ’ä»¶
type DemoPlugin struct{}

// New åˆ›å»ºæ¼”ç¤ºæ’ä»¶å®ä¾‹
func New() *DemoPlugin {
    return &DemoPlugin{}
}

// Name è¿”å›æ’ä»¶åç§°
func (p *DemoPlugin) Name() string {
    return "demo"
}

// Version è¿”å›æ’ä»¶ç‰ˆæœ¬
func (p *DemoPlugin) Version() string {
    return "1.0.0"
}

// Init åˆå§‹åŒ–æ’ä»¶
func (p *DemoPlugin) Init() error {
    // åˆ›å»ºæ¼”ç¤ºè¡¨
    query := `
        CREATE TABLE IF NOT EXISTS demo_items (
            id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    `
    _, err := db.DB.Exec(query)
    if err != nil {
        return fmt.Errorf("failed to create demo table: %w", err)
    }
    
    fmt.Println("âœ“ Demo plugin initialized")
    return nil
}

// RegisterRoutes æ³¨å†Œæ¼”ç¤ºè·¯ç”±
func (p *DemoPlugin) RegisterRoutes(router *gin.RouterGroup) {
    router.GET("/info", p.getInfo)
    router.GET("/items", p.getItems)
    router.POST("/items", p.createItem)
}

// getInfo è·å–æ’ä»¶ä¿¡æ¯
func (p *DemoPlugin) getInfo(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "plugin":  p.Name(),
        "version": p.Version(),
        "routes": []string{
            "/api/plugins/demo/info",
            "/api/plugins/demo/items",
        },
    })
}

// getItems è·å–æ¼”ç¤ºæ•°æ®
func (p *DemoPlugin) getItems(c *gin.Context) {
    var items []struct {
        ID          uint64 `db:"id" json:"id"`
        Name        string `db:"name" json:"name"`
        Description string `db:"description" json:"description"`
        CreatedAt   string `db:"created_at" json:"created_at"`
    }
    
    err := db.DB.Select(&items, "SELECT * FROM demo_items ORDER BY id DESC LIMIT 100")
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    
    c.JSON(http.StatusOK, gin.H{
        "items": items,
        "total": len(items),
    })
}

// createItem åˆ›å»ºæ¼”ç¤ºæ•°æ®
func (p *DemoPlugin) createItem(c *gin.Context) {
    var req struct {
        Name        string `json:"name" binding:"required"`
        Description string `json:"description"`
    }
    
    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }
    
    result, err := db.DB.Exec(
        "INSERT INTO demo_items (name, description) VALUES (?, ?)",
        req.Name, req.Description,
    )
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    
    id, _ := result.LastInsertId()
    c.JSON(http.StatusOK, gin.H{
        "id":      id,
        "name":    req.Name,
        "message": "Item created successfully",
    })
}
```

### æµ‹è¯• Demo æ’ä»¶

```bash
# 1. è·å–æ’ä»¶ä¿¡æ¯
curl http://localhost:8080/api/plugins/demo/info

# 2. åˆ›å»ºæ•°æ®
curl -X POST http://localhost:8080/api/plugins/demo/items \
  -H "Content-Type: application/json" \
  -d '{"name": "Test Item", "description": "This is a test"}'

# 3. è·å–æ•°æ®åˆ—è¡¨
curl http://localhost:8080/api/plugins/demo/items
```

---

## API å‚è€ƒ

### plugins/interface.go

| ç±»å‹/å‡½æ•° | ç­¾å | è¯´æ˜ |
|-----------|------|------|
| Plugin | interface | æ’ä»¶å¿…é¡»å®ç°çš„æ¥å£ |
| PluginManager | struct | æ’ä»¶ç®¡ç†å™¨ |
| NewPluginManager | `func NewPluginManager() *PluginManager` | åˆ›å»ºç®¡ç†å™¨ |
| Register | `func (pm *PluginManager) Register(p Plugin)` | æ³¨å†Œæ’ä»¶ |
| GetPlugins | `func (pm *PluginManager) GetPlugins() map[string]Plugin` | è·å–æ‰€æœ‰æ’ä»¶ |

---

> ğŸ“ **æœ€åæ›´æ–°**: 2026-02-04
> 
> å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒ `backend/app/plugins/interface.go` å’Œ `backend/app/plugins/demo/plugin.go` æºä»£ç ã€‚
