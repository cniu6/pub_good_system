# 路由问题修复说明

## 问题描述

1. 访问 `/#/system-mgr` 会跳转到 `/dashboard/workbench`，结果还是 404
2. 使用路由模式（history 模式）
3. `/dashboard/workbench` 始终都会跳转到这里

## 问题分析

### 问题 1: 管理端路由访问时跳转到主页

**根本原因**：
- 路由守卫中，当访问管理端路由时，如果路由未初始化，会调用 `initAuthRoute()`
- 但是路由初始化完成后，没有正确重新导航到管理端路由
- 导致访问管理端路由时，被重定向到主页

**修复方案**：
- 在路由守卫中，当路由初始化完成后，如果访问的是管理端路由，重新导航到目标路由
- 添加检查：如果路由已初始化，但是访问管理端路由时路由不存在，重新加载管理端路由

### 问题 2: 登录后重定向问题

**根本原因**：
- 登录后，如果用户是管理员，应该重定向到管理端，但是代码中重定向到了 `/`
- `/` 又会重定向到 `/dashboard/workbench`，导致管理员无法访问管理端

**修复方案**：
- 在登录后重定向逻辑中，如果用户是管理员且没有指定重定向路径，重定向到管理端
- 在路由守卫中，如果已登录用户访问登录页，管理员重定向到管理端，普通用户重定向到主页

## 修复内容

### 1. 路由守卫修复 (`frontend/src/router/guard.ts`)

#### 修复 1: 路由初始化后重新导航

```typescript
// 路由初始化完成后，重新导航到目标路由
if (to.name === '404' || isAdminRoute) {
  next({
    path: to.fullPath,
    replace: true,
    query: to.query,
    hash: to.hash,
  })
  return
}
```

#### 修复 2: 管理端路由重新加载检查

```typescript
// 如果路由已初始化，但是访问管理端路由时，检查管理端路由是否存在
if (routeStore.isInitAuthRoute && isAdminRoute && hasAdminRole && to.name === '404') {
  // 检查管理端路由是否已加载
  const adminRouteExists = router.hasRoute('admin-root')
  
  if (!adminRouteExists) {
    // 管理端路由未加载，重新加载
    const { loadAdminRoutes } = await import('@/router/admin.loader')
    const adminRoutes = await loadAdminRoutes()
    adminRoutes.forEach(route => {
      router.addRoute(route)
    })
    
    // 重新导航到目标路由
    next({
      path: to.fullPath,
      replace: true,
      query: to.query,
      hash: to.hash,
    })
    return
  }
}
```

#### 修复 3: 登录页重定向逻辑

```typescript
// 如果用户已登录且访问login页面，重定向到首页或管理端
if (to.name === 'login' && isLogin) {
  // 如果是管理员，重定向到管理端；否则重定向到主页
  if (hasAdminRole) {
    const adminPath = import.meta.env.VITE_ADMIN_BASE_PATH || import.meta.env.VITE_ADMIN_PATH || '/admin'
    next({ path: adminPath })
  } else {
    next({ path: import.meta.env.VITE_HOME_PATH || '/' })
  }
  return
}
```

### 2. 登录后重定向修复 (`frontend/src/store/auth.ts`)

```typescript
// 进行重定向跳转
const route = unref(router.currentRoute)
const query = route.query as { redirect: string }
const redirectPath = query.redirect || '/'

// 如果重定向路径是根路径，且用户是管理员，可以重定向到管理端
if (redirectPath === '/' && (data as any).role === 'admin') {
  const adminPath = import.meta.env.VITE_ADMIN_PATH || '/system-mgr'
  router.push({ path: adminPath })
} else {
  router.push({ path: redirectPath })
}
```

## 测试步骤

### 测试 1: 直接访问管理端路由

1. 使用管理员账号登录
2. 直接访问 `http://localhost:5173/#/system-mgr`
3. 应该能正常访问管理端仪表盘，不会跳转到主页

### 测试 2: 登录后自动跳转

1. 访问登录页
2. 使用管理员账号登录
3. 应该自动跳转到管理端（`/system-mgr`），而不是主页

### 测试 3: 刷新页面

1. 在管理端页面（如 `/system-mgr/users`）刷新页面
2. 应该能正常显示管理端页面，不会 404

### 测试 4: 路由模式测试

1. 确认 `VITE_ROUTE_MODE=web`（history 模式）
2. 访问 `http://localhost:5173/system-mgr`
3. 应该能正常访问，不会跳转到主页

## 注意事项

1. **环境变量配置**：
   - 确保 `VITE_ADMIN_PATH` 配置正确
   - 前端和后端的 `ADMIN_PATH` 必须一致

2. **路由模式**：
   - Hash 模式：`VITE_ROUTE_MODE=hash`，URL 格式：`/#/system-mgr`
   - History 模式：`VITE_ROUTE_MODE=web`，URL 格式：`/system-mgr`
   - History 模式需要后端配置支持（所有路由都返回 index.html）

3. **角色检查**：
   - 确保用户角色正确保存在 localStorage 中
   - 角色字段名应该是 `role`，值为 `'admin'`

4. **路由加载时机**：
   - 管理端路由是在路由初始化时动态加载的
   - 只有在用户是管理员时才会加载
   - 如果刷新页面，需要确保角色信息还在 localStorage 中

## 调试方法

如果仍然有问题，可以：

1. **检查浏览器控制台**：
   - 查看是否有 `[Admin Routes] 管理端路由已动态加载` 的日志
   - 查看是否有路由相关的错误信息

2. **检查 localStorage**：
   ```javascript
   // 在浏览器控制台执行
   console.log('role:', localStorage.getItem('role'))
   console.log('accessToken:', localStorage.getItem('accessToken'))
   ```

3. **检查路由列表**：
   ```javascript
   // 在浏览器控制台执行
   console.log('routes:', router.getRoutes())
   ```

4. **检查当前路由**：
   ```javascript
   // 在浏览器控制台执行
   console.log('currentRoute:', router.currentRoute.value)
   ```

