# æ•°æ®åº“æ¨¡å‹ - å®Œæ•´ä½¿ç”¨æŒ‡å—

> ğŸ—„ï¸ **æ–‡æ¡£ä½ç½®**: `doc/æ•°æ®åº“æ¨¡å‹.md`
> 
> **å…³è”æ–‡ä»¶**:
> - `backend/internal/db/mysql.go` - æ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–
> - `backend/app/models/*.go` - æ•°æ®æ¨¡å‹å®šä¹‰
> - `backend/internal/config/config.go` - æ•°æ®åº“é…ç½®

---

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
3. [æ•°æ®åº“è¿æ¥](#æ•°æ®åº“è¿æ¥)
4. [æ¨¡å‹å®šä¹‰](#æ¨¡å‹å®šä¹‰)
5. [CRUD æ“ä½œ](#crud-æ“ä½œ)
6. [äº‹åŠ¡å¤„ç†](#äº‹åŠ¡å¤„ç†)
7. [è¡¨ç»“æ„](#è¡¨ç»“æ„)
8. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ•°æ®è®¿é—®å±‚æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Controller  â”€â”€â–º  Model  â”€â”€â–º  sqlx  â”€â”€â–º  MySQL Driver          â”‚
â”‚       â”‚              â”‚          â”‚            â”‚                  â”‚
â”‚       â”‚              â”‚          â”‚            â–¼                  â”‚
â”‚       â”‚              â”‚          â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚              â”‚          â”‚      â”‚  MySQL   â”‚            â”‚
â”‚       â”‚              â”‚          â”‚      â”‚  Server  â”‚            â”‚
â”‚       â”‚              â”‚          â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚              â”‚          â”‚                              â”‚
â”‚       â”‚              â–¼          â”‚                              â”‚
â”‚       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                              â”‚
â”‚       â”‚         â”‚  User    â”‚    â”‚                              â”‚
â”‚       â”‚         â”‚  Email   â”‚    â”‚                              â”‚
â”‚       â”‚         â”‚  Code    â”‚    â”‚                              â”‚
â”‚       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| DB è¿æ¥ | `internal/db/mysql.go` | æ•°æ®åº“è¿æ¥æ±  |
| User æ¨¡å‹ | `app/models/user.go` | ç”¨æˆ·æ•°æ®æ“ä½œ |
| Email æ¨¡å‹ | `app/models/email.go` | é‚®ä»¶ç›¸å…³æ“ä½œ |
| Code æ¨¡å‹ | `app/models/verification_code.go` | éªŒè¯ç æ“ä½œ |
| Base æ¨¡å‹ | `app/models/base.go` | åŸºç¡€æ¨¡å‹ç»“æ„ |

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ•°æ®åº“è¿æ¥ï¼š

```env
# MySQL é…ç½®
DB_HOST=127.0.0.1      # æ•°æ®åº“ä¸»æœº
DB_PORT=3306           # æ•°æ®åº“ç«¯å£
DB_USER=root           # ç”¨æˆ·å
DB_PASSWORD=password   # å¯†ç 
DB_NAME=fst_platform   # æ•°æ®åº“å
```

### é…ç½®ä»£ç 

**æ–‡ä»¶**: `backend/internal/config/config.go`

```go
// buildDSN æ„å»ºæ•°æ®æºåç§°
func buildDSN() string {
    user := getEnv("DB_USER", "root")
    pass := getEnv("DB_PASSWORD", "")
    host := getEnv("DB_HOST", "127.0.0.1")
    port := getEnv("DB_PORT", "3306")
    name := getEnv("DB_NAME", "fst_platform")
    
    return user + ":" + pass + "@tcp(" + host + ":" + port + ")/" + name + 
        "?charset=utf8mb4&parseTime=True&loc=Local"
}
```

### DSN å‚æ•°è¯´æ˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| charset | utf8mb4 | æ”¯æŒå®Œæ•´çš„ UTF-8ï¼ˆåŒ…æ‹¬ emojiï¼‰ |
| parseTime | True | è‡ªåŠ¨è§£ææ—¶é—´ç±»å‹ä¸º time.Time |
| loc | Local | ä½¿ç”¨æœ¬åœ°æ—¶åŒº |

---

## æ•°æ®åº“è¿æ¥

### åˆå§‹åŒ–è¿æ¥

**æ–‡ä»¶**: `backend/internal/db/mysql.go`

```go
package db

import (
    "log"
    
    "github.com/jmoiron/sqlx"
    _ "github.com/go-sql-driver/mysql"
)

var DB *sqlx.DB

// InitDB åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
func InitDB(dsn string) error {
    var err error
    DB, err = sqlx.Connect("mysql", dsn)
    if err != nil {
        return err
    }
    
    // è¿æ¥æ± é…ç½®
    DB.SetMaxOpenConns(25)    // æœ€å¤§æ‰“å¼€è¿æ¥æ•°
    DB.SetMaxIdleConns(10)    // æœ€å¤§ç©ºé—²è¿æ¥æ•°
    
    return nil
}
```

### ä½¿ç”¨è¿æ¥

```go
import "fst/backend/internal/db"

// æ‰§è¡ŒæŸ¥è¯¢
var users []User
err := db.DB.Select(&users, "SELECT * FROM users")

// æ‰§è¡Œæ’å…¥
result, err := db.DB.Exec("INSERT INTO users (name) VALUES (?)", name)

// è·å–å•è¡Œ
var user User
err := db.DB.Get(&user, "SELECT * FROM users WHERE id = ?", id)
```

### è¿æ¥æ± æœ€ä½³é…ç½®

```go
func InitDB(dsn string) error {
    DB, err = sqlx.Connect("mysql", dsn)
    if err != nil {
        return err
    }
    
    // è¿æ¥æ± é…ç½®
    DB.SetMaxOpenConns(25)        // æœ€å¤§æ‰“å¼€è¿æ¥
    DB.SetMaxIdleConns(10)        // æœ€å¤§ç©ºé—²è¿æ¥
    DB.SetConnMaxLifetime(5 * time.Minute)  // è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
    DB.SetConnMaxIdleTime(1 * time.Minute)  // ç©ºé—²è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
    
    // éªŒè¯è¿æ¥
    if err := DB.Ping(); err != nil {
        return err
    }
    
    return nil
}
```

---

## æ¨¡å‹å®šä¹‰

### åŸºç¡€æ¨¡å‹ç»“æ„

**æ–‡ä»¶**: `backend/app/models/base.go`

```go
package models

import "time"

// BaseModel åŸºç¡€æ¨¡å‹
type BaseModel struct {
    ID        uint64    `db:"id" json:"id"`
    CreatedAt time.Time `db:"created_at" json:"created_at"`
    UpdatedAt time.Time `db:"updated_at" json:"updated_at"`
}
```

### User æ¨¡å‹

**æ–‡ä»¶**: `backend/app/models/user.go`

```go
package models

import (
    "database/sql"
    "time"
    "fst/backend/internal/db"
)

// User ç”¨æˆ·æ¨¡å‹
type User struct {
    ID            uint64         `db:"id" json:"id"`
    GroupID       uint64         `db:"group_id" json:"group_id"`
    Username      string         `db:"username" json:"username"`
    Nickname      sql.NullString `db:"nickname" json:"nickname"`
    Email         string         `db:"email" json:"email"`
    Mobile        sql.NullString `db:"mobile" json:"mobile"`
    Avatar        sql.NullString `db:"avatar" json:"avatar"`
    BackGround    sql.NullString `db:"back_ground" json:"back_ground"`
    Gender        int            `db:"gender" json:"gender"`
    Birthday      sql.NullTime   `db:"birthday" json:"birthday"`
    Password      string         `db:"password" json:"-"`  // ä¸åºåˆ—åŒ–åˆ°JSON
    Role          string         `db:"role" json:"role"`
    Status        int            `db:"status" json:"status"`
    LastLoginTime sql.NullTime   `db:"last_login_time" json:"last_login_time"`
    LastLoginIP   sql.NullString `db:"last_login_ip" json:"last_login_ip"`
    DeleteTime    sql.NullTime   `db:"delete_time" json:"delete_time,omitempty"`
    CreatedAt     time.Time      `db:"created_at" json:"created_at"`
    UpdatedAt     time.Time      `db:"updated_at" json:"updated_at"`
}
```

### sql.NullXXX ç±»å‹è¯´æ˜

| ç±»å‹ | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| sql.NullString | å¯ä¸º NULL çš„å­—ç¬¦ä¸² | `sql.NullString{String: "value", Valid: true}` |
| sql.NullInt64 | å¯ä¸º NULL çš„æ•´æ•° | `sql.NullInt64{Int64: 123, Valid: true}` |
| sql.NullTime | å¯ä¸º NULL çš„æ—¶é—´ | `sql.NullTime{Time: now, Valid: true}` |
| sql.NullFloat64 | å¯ä¸º NULL çš„æµ®ç‚¹æ•° | - |
| sql.NullBool | å¯ä¸º NULL çš„å¸ƒå°”å€¼ | - |

**ä½¿ç”¨ç¤ºä¾‹**:
```go
// åˆ›å»ºç”¨æˆ·æ—¶ä½¿ç”¨ sql.NullString
user := &User{
    Username: "john",
    Nickname: sql.NullString{String: "John Doe", Valid: true},
    Email:    "john@example.com",
    Mobile:   sql.NullString{},  // NULL
}

// è¯»å–æ—¶æ£€æŸ¥æœ‰æ•ˆæ€§
if user.Nickname.Valid {
    fmt.Println(user.Nickname.String)
} else {
    fmt.Println("No nickname")
}
```

---

## CRUD æ“ä½œ

### Createï¼ˆåˆ›å»ºï¼‰

```go
// CreateUser åˆ›å»ºç”¨æˆ·
func CreateUser(user *User) error {
    query := `
        INSERT INTO users (
            group_id, username, nickname, email, mobile, 
            avatar, password, role, status
        ) VALUES (
            :group_id, :username, :nickname, :email, :mobile,
            :avatar, :password, :role, :status
        )
    `
    result, err := db.DB.NamedExec(query, user)
    if err != nil {
        return err
    }
    
    // è·å–æ’å…¥çš„ID
    id, _ := result.LastInsertId()
    user.ID = uint64(id)
    
    return nil
}

// ä½¿ç”¨ç¤ºä¾‹
user := &models.User{
    Username: "newuser",
    Email:    "new@example.com",
    Password: hashedPassword,
    Role:     "user",
    Status:   1,
}

if err := models.CreateUser(user); err != nil {
    // å¤„ç†é”™è¯¯
}
fmt.Printf("Created user with ID: %d\n", user.ID)
```

### Readï¼ˆæŸ¥è¯¢ï¼‰

```go
// GetUserByID é€šè¿‡IDè·å–ç”¨æˆ·
func GetUserByID(id uint64) (*User, error) {
    var user User
    err := db.DB.Get(&user, 
        "SELECT * FROM users WHERE id = ? AND delete_time IS NULL", 
        id,
    )
    if err == sql.ErrNoRows {
        return nil, nil
    }
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// GetUserByUsername é€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·
func GetUserByUsername(username string) (*User, error) {
    var user User
    err := db.DB.Get(&user, 
        "SELECT * FROM users WHERE username = ? AND delete_time IS NULL", 
        username,
    )
    if err == sql.ErrNoRows {
        return nil, nil
    }
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// GetUserByEmail é€šè¿‡é‚®ç®±è·å–ç”¨æˆ·
func GetUserByEmail(email string) (*User, error) {
    var user User
    err := db.DB.Get(&user, 
        "SELECT * FROM users WHERE email = ? AND delete_time IS NULL", 
        email,
    )
    if err == sql.ErrNoRows {
        return nil, nil
    }
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// GetUserByUsernameOrEmail é€šè¿‡ç”¨æˆ·åæˆ–é‚®ç®±è·å–ç”¨æˆ·
func GetUserByUsernameOrEmail(identifier string) (*User, error) {
    var user User
    err := db.DB.Get(&user, 
        "SELECT * FROM users WHERE (username = ? OR email = ?) AND delete_time IS NULL", 
        identifier, identifier,
    )
    if err == sql.ErrNoRows {
        return nil, nil
    }
    if err != nil {
        return nil, err
    }
    return &user, nil
}

// GetUsers è·å–ç”¨æˆ·åˆ—è¡¨
func GetUsers(offset, limit int) ([]User, error) {
    var users []User
    err := db.DB.Select(&users, 
        "SELECT * FROM users WHERE delete_time IS NULL ORDER BY id DESC LIMIT ? OFFSET ?", 
        limit, offset,
    )
    return users, err
}

// SearchUsers æœç´¢ç”¨æˆ·
func SearchUsers(keyword string) ([]User, error) {
    var users []User
    pattern := "%" + keyword + "%"
    err := db.DB.Select(&users, 
        "SELECT * FROM users WHERE delete_time IS NULL AND (username LIKE ? OR email LIKE ?)", 
        pattern, pattern,
    )
    return users, err
}
```

### Updateï¼ˆæ›´æ–°ï¼‰

```go
// UpdateUser æ›´æ–°ç”¨æˆ·ä¿¡æ¯
func UpdateUser(user *User) error {
    query := `
        UPDATE users SET
            nickname = :nickname,
            email = :email,
            mobile = :mobile,
            avatar = :avatar,
            role = :role,
            status = :status,
            updated_at = NOW()
        WHERE id = :id AND delete_time IS NULL
    `
    _, err := db.DB.NamedExec(query, user)
    return err
}

// UpdatePassword æ›´æ–°å¯†ç 
func UpdatePassword(userID uint64, hashedPassword string) error {
    _, err := db.DB.Exec(
        "UPDATE users SET password = ?, updated_at = NOW() WHERE id = ?",
        hashedPassword, userID,
    )
    return err
}

// UpdateLastLogin æ›´æ–°æœ€åç™»å½•ä¿¡æ¯
func UpdateLastLogin(userID uint64, ip string) error {
    _, err := db.DB.Exec(
        "UPDATE users SET last_login_time = NOW(), last_login_ip = ? WHERE id = ?",
        ip, userID,
    )
    return err
}

// ä½¿ç”¨ç¤ºä¾‹
user, _ := models.GetUserByID(123)
user.Nickname = sql.NullString{String: "New Name", Valid: true}
if err := models.UpdateUser(user); err != nil {
    log.Printf("Update failed: %v", err)
}
```

### Deleteï¼ˆåˆ é™¤ï¼‰

```go
// SoftDeleteUser è½¯åˆ é™¤ç”¨æˆ·
func SoftDeleteUser(userID uint64) error {
    _, err := db.DB.Exec(
        "UPDATE users SET delete_time = NOW() WHERE id = ? AND delete_time IS NULL",
        userID,
    )
    return err
}

// HardDeleteUser ç¡¬åˆ é™¤ç”¨æˆ·
func HardDeleteUser(userID uint64) error {
    _, err := db.DB.Exec(
        "DELETE FROM users WHERE id = ?",
        userID,
    )
    return err
}

// RestoreUser æ¢å¤è½¯åˆ é™¤çš„ç”¨æˆ·
func RestoreUser(userID uint64) error {
    _, err := db.DB.Exec(
        "UPDATE users SET delete_time = NULL WHERE id = ?",
        userID,
    )
    return err
}
```

---

## äº‹åŠ¡å¤„ç†

### åŸºæœ¬äº‹åŠ¡

```go
func TransferMoney(fromID, toID uint64, amount float64) error {
    tx, err := db.DB.Beginx()
    if err != nil {
        return err
    }
    
    // ç¡®ä¿äº‹åŠ¡å›æ»šæˆ–æäº¤
    defer func() {
        if err != nil {
            tx.Rollback()
        } else {
            err = tx.Commit()
        }
    }()
    
    // æ‰£æ¬¾
    _, err = tx.Exec("UPDATE accounts SET balance = balance - ? WHERE id = ?", amount, fromID)
    if err != nil {
        return err
    }
    
    // åŠ æ¬¾
    _, err = tx.Exec("UPDATE accounts SET balance = balance + ? WHERE id = ?", amount, toID)
    if err != nil {
        return err
    }
    
    // è®°å½•äº¤æ˜“
    _, err = tx.Exec(
        "INSERT INTO transactions (from_id, to_id, amount) VALUES (?, ?, ?)",
        fromID, toID, amount,
    )
    if err != nil {
        return err
    }
    
    return nil
}
```

### äº‹åŠ¡å°è£…å‡½æ•°

```go
// WithTransaction äº‹åŠ¡å°è£…
func WithTransaction(fn func(*sqlx.Tx) error) error {
    tx, err := db.DB.Beginx()
    if err != nil {
        return err
    }
    
    defer func() {
        if p := recover(); p != nil {
            tx.Rollback()
            panic(p)
        } else if err != nil {
            tx.Rollback()
        } else {
            err = tx.Commit()
        }
    }()
    
    err = fn(tx)
    return err
}

// ä½¿ç”¨ç¤ºä¾‹
err := WithTransaction(func(tx *sqlx.Tx) error {
    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œ
    if _, err := tx.Exec("INSERT ..."); err != nil {
        return err
    }
    if _, err := tx.Exec("UPDATE ..."); err != nil {
        return err
    }
    return nil
})
```

---

## è¡¨ç»“æ„

### users è¡¨

```sql
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT 'ç”¨æˆ·ID',
    group_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'åˆ†ç»„ID',
    username VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    nickname VARCHAR(50) COMMENT 'æ˜µç§°',
    email VARCHAR(150) NOT NULL COMMENT 'é‚®ç®±',
    mobile VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    avatar VARCHAR(255) COMMENT 'å¤´åƒURL',
    back_ground VARCHAR(255) COMMENT 'èƒŒæ™¯å›¾URL',
    gender TINYINT NOT NULL DEFAULT 0 COMMENT 'æ€§åˆ« 0æœªçŸ¥ 1ç”· 2å¥³',
    birthday DATE COMMENT 'ç”Ÿæ—¥',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    role VARCHAR(20) NOT NULL DEFAULT 'user' COMMENT 'è§’è‰²',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ 0ç¦ç”¨ 1å¯ç”¨',
    last_login_time TIMESTAMP NULL COMMENT 'æœ€åç™»å½•æ—¶é—´',
    last_login_ip VARCHAR(50) COMMENT 'æœ€åç™»å½•IP',
    delete_time TIMESTAMP NULL COMMENT 'è½¯åˆ é™¤æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY idx_users_username (username),
    UNIQUE KEY idx_users_email (email),
    KEY idx_users_group (group_id),
    KEY idx_users_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

### email_logs è¡¨

```sql
CREATE TABLE IF NOT EXISTS email_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    to_email VARCHAR(150) NOT NULL COMMENT 'æ”¶ä»¶äºº',
    subject VARCHAR(255) NOT NULL COMMENT 'ä¸»é¢˜',
    content TEXT COMMENT 'å†…å®¹',
    template_name VARCHAR(50) COMMENT 'ä½¿ç”¨çš„æ¨¡æ¿',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ 0å¤±è´¥ 1æˆåŠŸ',
    error_msg TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    KEY idx_email_logs_to (to_email),
    KEY idx_email_logs_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‚®ä»¶å‘é€æ—¥å¿—';
```

### email_templates è¡¨

```sql
CREATE TABLE IF NOT EXISTS email_templates (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL COMMENT 'æ¨¡æ¿æ ‡è¯†',
    lang VARCHAR(10) NOT NULL DEFAULT 'zh-CN' COMMENT 'è¯­è¨€',
    title VARCHAR(100) COMMENT 'æ ‡é¢˜',
    subject VARCHAR(255) NOT NULL COMMENT 'é‚®ä»¶ä¸»é¢˜',
    content TEXT NOT NULL COMMENT 'é‚®ä»¶å†…å®¹',
    description TEXT COMMENT 'æè¿°',
    variables TEXT COMMENT 'å¯ç”¨å˜é‡è¯´æ˜',
    status TINYINT NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ 0ç¦ç”¨ 1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY idx_email_tpl_name_lang (name, lang),
    KEY idx_email_tpl_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‚®ä»¶æ¨¡æ¿';
```

### verification_codes è¡¨

```sql
CREATE TABLE IF NOT EXISTS verification_codes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL COMMENT 'é‚®ç®±åœ°å€',
    code VARCHAR(10) NOT NULL COMMENT 'éªŒè¯ç ',
    code_type VARCHAR(50) NOT NULL COMMENT 'ç±»å‹ register/reset_password',
    expires_at TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    is_used TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦å·²ä½¿ç”¨',
    is_deleted TINYINT NOT NULL DEFAULT 0 COMMENT 'æ˜¯å¦åˆ é™¤ï¼ˆè½¯åˆ ï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_email_type (email, code_type),
    INDEX idx_expires (expires_at),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='éªŒè¯ç è¡¨';
```

---

## æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ Named Query

```go
// âœ… æ¨èï¼šä½¿ç”¨å‘½åå‚æ•°
query := `
    INSERT INTO users (username, email, password)
    VALUES (:username, :email, :password)
`
result, err := db.DB.NamedExec(query, user)

// âŒ ä¸æ¨èï¼šä½ç½®å‚æ•°å®¹æ˜“å‡ºé”™
query := "INSERT INTO users (username, email) VALUES (?, ?)"
result, err := db.DB.Exec(query, user.Username, user.Email)
```

### 2. è½¯åˆ é™¤ä¼˜å…ˆ

```go
// âœ… æ¨èï¼šè½¯åˆ é™¤
func DeleteUser(id uint64) error {
    _, err := db.DB.Exec(
        "UPDATE users SET delete_time = NOW() WHERE id = ?",
        id,
    )
    return err
}

// æŸ¥è¯¢æ—¶æ’é™¤å·²åˆ é™¤
func GetUser(id uint64) (*User, error) {
    var user User
    err := db.DB.Get(&user, 
        "SELECT * FROM users WHERE id = ? AND delete_time IS NULL",
        id,
    )
    return &user, err
}
```

### 3. é”™è¯¯å¤„ç†

```go
func GetUserByID(id uint64) (*User, error) {
    var user User
    err := db.DB.Get(&user, "SELECT * FROM users WHERE id = ?", id)
    
    if err == sql.ErrNoRows {
        // è®°å½•ä½†ä¸è§†ä¸ºé”™è¯¯
        log.Printf("User %d not found", id)
        return nil, nil
    }
    if err != nil {
        // åŒ…è£…é”™è¯¯ä¿¡æ¯
        return nil, fmt.Errorf("failed to get user %d: %w", id, err)
    }
    
    return &user, nil
}
```

### 4. æ‰¹é‡æ“ä½œ

```go
// æ‰¹é‡æ’å…¥
func CreateUsers(users []User) error {
    query := "INSERT INTO users (username, email) VALUES (:username, :email)"
    _, err := db.DB.NamedExec(query, users)
    return err
}

// æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨ CASE WHENï¼‰
func UpdateUserStatuses(updates map[uint64]int) error {
    if len(updates) == 0 {
        return nil
    }
    
    // æ„å»ºåŠ¨æ€ SQL
    var ids []uint64
    var cases []string
    for id, status := range updates {
        ids = append(ids, id)
        cases = append(cases, fmt.Sprintf("WHEN %d THEN %d", id, status))
    }
    
    query := fmt.Sprintf(`
        UPDATE users 
        SET status = CASE id %s END,
            updated_at = NOW()
        WHERE id IN (?)
    `, strings.Join(cases, " "))
    
    query, args, _ := sqlx.In(query, ids)
    query = db.DB.Rebind(query)
    _, err := db.DB.Exec(query, args...)
    return err
}
```

### 5. åˆ†é¡µæŸ¥è¯¢

```go
type Pagination struct {
    Page     int `json:"page" form:"page"`
    PageSize int `json:"pageSize" form:"pageSize"`
}

func (p *Pagination) Offset() int {
    return (p.Page - 1) * p.PageSize
}

func (p *Pagination) Limit() int {
    if p.PageSize <= 0 {
        return 10
    }
    if p.PageSize > 100 {
        return 100
    }
    return p.PageSize
}

// åˆ†é¡µæŸ¥è¯¢
func GetUsersPaged(p Pagination) ([]User, int64, error) {
    var users []User
    var total int64
    
    // è·å–æ€»æ•°
    err := db.DB.Get(&total, "SELECT COUNT(*) FROM users WHERE delete_time IS NULL")
    if err != nil {
        return nil, 0, err
    }
    
    // è·å–æ•°æ®
    err = db.DB.Select(&users, 
        "SELECT * FROM users WHERE delete_time IS NULL ORDER BY id DESC LIMIT ? OFFSET ?",
        p.Limit(), p.Offset(),
    )
    
    return users, total, err
}
```

### 6. é¿å… SQL æ³¨å…¥

```go
// âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
username := c.Query("username")
user, err := models.GetUserByUsername(username)  // å†…éƒ¨ä½¿ç”¨ ? å ä½ç¬¦

// âŒ å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥
query := fmt.Sprintf("SELECT * FROM users WHERE username = '%s'", username)  // æ°¸è¿œä¸è¦è¿™æ ·ï¼
```

---

## API å‚è€ƒ

### models/user.go

| å‡½æ•° | ç­¾å | è¯´æ˜ |
|------|------|------|
| CreateUser | `func CreateUser(user *User) error` | åˆ›å»ºç”¨æˆ· |
| GetUserByID | `func GetUserByID(id uint64) (*User, error)` | é€šè¿‡IDè·å–ç”¨æˆ· |
| GetUserByUsername | `func GetUserByUsername(username string) (*User, error)` | é€šè¿‡ç”¨æˆ·åè·å– |
| GetUserByEmail | `func GetUserByEmail(email string) (*User, error)` | é€šè¿‡é‚®ç®±è·å– |
| GetUserByUsernameOrEmail | `func GetUserByUsernameOrEmail(identifier string) (*User, error)` | ç”¨æˆ·åæˆ–é‚®ç®± |
| UpdateUser | `func UpdateUser(user *User) error` | æ›´æ–°ç”¨æˆ· |
| UpdatePassword | `func UpdatePassword(userID uint64, hashedPassword string) error` | æ›´æ–°å¯†ç  |
| SoftDeleteUser | `func SoftDeleteUser(userID uint64) error` | è½¯åˆ é™¤ç”¨æˆ· |

### models/email.go

| å‡½æ•° | ç­¾å | è¯´æ˜ |
|------|------|------|
| CreateEmailLog | `func CreateEmailLog(to, subject, content, tplName string, status int, errorMsg string) error` | åˆ›å»ºé‚®ä»¶æ—¥å¿— |
| GetEmailTemplate | `func GetEmailTemplate(name, lang string) (*EmailTemplate, error)` | è·å–é‚®ä»¶æ¨¡æ¿ |

### models/verification_code.go

| å‡½æ•° | ç­¾å | è¯´æ˜ |
|------|------|------|
| CreateVerificationCode | `func CreateVerificationCode(email, code, codeType string, expiresAt time.Time) error` | åˆ›å»ºéªŒè¯ç  |
| VerifyCode | `func VerifyCode(email, code, codeType string) (bool, uint64, error)` | éªŒè¯éªŒè¯ç  |
| MarkVerificationCodeAsUsed | `func MarkVerificationCodeAsUsed(codeID uint64) error` | æ ‡è®°å·²ä½¿ç”¨ |

---

> ğŸ“ **æœ€åæ›´æ–°**: 2026-02-04
> 
> å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒ `backend/app/models/*.go` æºä»£ç ã€‚
